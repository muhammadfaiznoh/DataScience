# -*- coding: utf-8 -*-
"""Load insurance into BigQuery .ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1IjBx_MrBVQd4YRfv2hTpX_ORZPjb7xOT

## BigQuery Project Settings and Medical Cost Personal Datasets
"""

project_id = "inusrance"
dataset = "insurance"
table_name = "insuranceData"
csv_file_url = "https://raw.githubusercontent.com/stedy/Machine-Learning-with-R-datasets/d20658ec6d336af2d4ddb5fd72b6f677dd46136e/insurance.csv"

"""## Import Libaries into Colab"""

import pandas as pd
import pandas_gbq
import zipfile
import seaborn as sns
import matplotlib.pyplot as plt

from pydrive.auth import GoogleAuth 
from google.colab import auth
from oauth2client.client import GoogleCredentials 

auth.authenticate_user()
gauth = GoogleAuth() 
gauth.credentials = GoogleCredentials.get_application_default()

"""## Download CSV from GitHub into Colab 

Get file id from Github Shared Link then get content of the file and save inside Colab
"""

file_id = csv_file_url.split("/")[-2]
print(f"CSV File id : {file_id}")


print("Downloaded")

"""## Read CSV file with Pandas and Scrub the data

Add another column for smoker as binary format
"""

#csv_file_name = zip_file_name.replace(".zip", "")
df = pd.read_csv(csv_file_url)
df['smoker_code'] = df['smoker'].str.strip().map({"yes":1, "no":0})
df.head()

"""# Find correlation between each variables"""

corr = df.corr()
sns.set(rc={'figure.figsize':(12,10)})
sns.heatmap(corr, annot = True) # annot -> annotation

"""
#  Descriptive analytics / statistical summary

"""

df.describe()

"""# Supervised Learning Algorithms: Linear Regression"""

column = ['bmi','smoker_code','age']

X = df[column]

y = df['charges']

from sklearn.linear_model import LinearRegression
model = LinearRegression()
model.fit(X,y)
print("coefficents:", model.coef_)
print("intercept:", model.intercept_)

model.score(X, y)

"""Prediction for charges when BMI is 40, a smoker and 20 years old"""

model.predict([[40,1,20]])

"""# Scatter plot for BMI vs charges with smoking as 3rd variable"""

for smoker in ['yes' , 'no']:
  sns.scatterplot(x='bmi', y='charges',data = df[df['smoker'] == smoker],s = 200 , alpha = 1 , label = smoker)

"""# Scatter plot for age vs charges with smoking as 3rd variable"""

for smoker in ['yes' , 'no']:
  sns.scatterplot(x='age', y='charges',data = df[df['smoker'] == smoker],s = 200 , alpha = 1 , label = smoker)

"""# Unsupervised Learning Algorithms: K-Means Clustering

Elbow Method to choose optimal number for cluster
"""

distortions = []
K = range(1,10)
for k in K:
    kmeanModel = KMeans(n_clusters=k)
    kmeanModel.fit(df[X])
    distortions.append(kmeanModel.inertia_)
plt.figure(figsize=(16,8))
plt.plot(K, distortions, 'bx-')
plt.xlabel('k')
plt.ylabel('Distortion')
plt.title('The Elbow Method showing the optimal k')
plt.show()

from sklearn.cluster import KMeans
k = 3
X = ['charges','bmi']
kmeans = KMeans(n_clusters=k).fit(df[X])

centroids = kmeans.cluster_centers_
df['label'] = kmeans.labels_.astype(str)
#groups = {"0":centroids[0], "1":centroids[1], "2":centroids[2], "3":centroids}
#customPalette = ['#630C3A', '#39C8C6', '#D3500C', '#FFB139']
#labelPalette = ['#FFFFFF', '#39C8C6', '#D3500C', '#FFB139']
for i in range(k):
      #add data points 
    plt.scatter(x=df.loc[df['label']==str(i), 'charges'], 
                y=df.loc[df['label']==str(i),'bmi'], 
                color=sns.color_palette("muted")[i], s = 200,
                alpha=0.50)
    #add label
    plt.annotate(str(i), 
                 centroids[i],
                 horizontalalignment='center',
                 verticalalignment='center',
                 size=30, weight='bold',
                 color='black')

"""Output after clustering """

df

"""## Push data into BigQuery"""

# Push the table into Google BigQuery Table
pandas_gbq.to_gbq(
        df, 
        f"{dataset}.{table_name}", 
        project_id=project_id,
        if_exists='replace'
      )

"""SQL query for data analytic purpose

```
SELECT age,
  CASE
    WHEN age BETWEEN 18 AND 35 THEN 'youth'
    WHEN age BETWEEN 36
  AND 55 THEN 'adult'
    WHEN age > 55 THEN 'elder'
END
  AS age_group,
  CASE
    WHEN bmi <18.5 THEN 'Underweight'
    WHEN bmi BETWEEN 18.5 AND 24.9 THEN 'Normal'
WHEN bmi BETWEEN 25.0 AND 29.9 THEN 'Overweight'
    ELSE   'OBESE'
END
  AS bmi_status,
  sex,
  bmi,
  smoker_code,smoker,
  charges
FROM
  `inusrance.insurance.insuranceData`
```

[Medical Cost Analytics ](https://datastudio.google.com/reporting/608ec992-d706-4945-9895-2eefae7b79c4)
"""